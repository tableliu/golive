!function(e){function t(t,n){this.element=e(t),this.options=n||{},this.init()}function n(t){t.preventDefault();var n=e(t.currentTarget),a=n.parents(".rule");n.trigger("remove"),a.remove()}function a(t){var n=e(this),a=n.find("> :selected"),l=n.parents(".rule"),o=l.find(".field"),r=l.find(".value");r.val();switch(a.data("fieldType")){case"none":n.after(e("<input>",{type:"hidden",class:"value form-control"}));break;case"text":n.after(e("<input>",{type:"text",class:"value form-control"}));break;case"email":n.after(e("<input>",{type:"email",class:"value form-control"}));break;case"number":n.after(e("<input>",{type:"number",class:"value form-control"}));break;case"color":n.after(e("<input>",{type:"color",class:"value form-control"}));break;case"range":n.after(e("<input>",{type:"range",class:"value form-control"}));break;case"textarea":n.after(e("<textarea>",{class:"value form-control"}));break;case"select":for(var i=e("<select>",{class:"value form-control"}),s=o.find("> :selected").data("options"),p=0;p<s.length;p++){var c=s[p];i.append(e("<option>",{text:c.label||c.value,value:c.value}))}n.after(i);break;case"select_multiple":var d=(s=o.find("> :selected").data("options")).length>10?10:s.length;for(i=e("<select class='value form-control' multiple size='"+d+"''></select>"),p=0;p<s.length;p++){c=s[p];i.append(e("<option>",{text:c.label||c.value,value:c.value}))}n.after(i)}r.remove()}e.fn.conditionsBuilder=function(n){return"data"==n?e(this).eq(0).data("conditionsBuilder").collectData():e(this).each(function(){var a=new t(this,n);e(this).data("conditionsBuilder",a)})},t.prototype={init:function(){this.fields=this.denormalizeOperators(this.options.variables,this.options.variable_type_operators),this.data=this.options.data||{all:[]};var e=this.buildRules(this.data);this.element.html(e)},denormalizeOperators:function(t,n){return e.map(t,function(e){return e.operators=n[e.fieldType],e})},collectData:function(){return this.collectDataFromNode(this.element.find("> .conditional"))},collectDataFromNode:function(t){var n=null,a=this;if(t.is(".conditional")&&(n=t.find("> .all-any-none-wrapper > .all-any-none").val()),n){var l={};return l[n]=[],t.find("> .conditional, > .rule").each(function(){l[n].push(a.collectDataFromNode(e(this)))}),l}return{name:t.find(".field").val(),operator:t.find(".operator").val(),value:t.find(".value").val()}},buildRules:function(e){return this.buildConditional(e)||this.buildRule(e)},buildConditional:function(t){var n;if(t.all?n="all":t.any?n="any":t.none&&(n="none"),n){var a=e("<div>",{class:"conditional "+n}),l=e("<div>",{class:"all-any-none-wrapper"}),o=e("<select>",{class:"all-any-none form-control"});o.append(e("<option>",{value:"all",text:options.i18n.all,selected:"all"==n})),o.append(e("<option>",{value:"any",text:options.i18n.any,selected:"any"==n})),o.append(e("<option>",{value:"none",text:options.i18n.none,selected:"none"==n})),l.append(o),l.append(e("<span>",{text:options.i18n.followingConditions})),a.append(l);var r=e("<span>",{class:"glyphicon glyphicon-plus",text:" "}),i=e("<a>",{href:"#",class:"add-rule btn btn-warning btn-xs",text:options.i18n.addCondition});i.prepend(r),i.prepend(r);var s=this;i.click(function(e){e.preventDefault();var t=s.fields[0],n={name:t.value,operator:t.operators[0],value:null};a.append(s.buildRule(n))}),a.append(i);var p=e("<span>",{class:"glyphicon glyphicon-plus",text:" "}),c=e("<a>",{href:"#",class:"add-condition btn btn-warning btn-xs",text:options.i18n.addGroup});c.prepend(p),c.click(function(e){e.preventDefault();var t=s.fields[0],n={all:[{name:t.value,operator:t.operators[0],value:null}]};a.append(s.buildConditional(n))}),a.append(c);var d=e("<span>",{class:"glyphicon glyphicon-remove",text:" "}),u=e("<a>",{class:"remove btn btn-danger btn-xs",href:"#",text:options.i18n.deleteText});u.prepend(d),u.click(function(t){t.preventDefault(),e(this).trigger("remove"),a.remove()}),a.append(u);for(var f=t[n],v=0;v<f.length;v++)a.append(this.buildRules(f[v]));return a}},buildRule:function(t){var l,o=e("<div>",{class:"rule"}),r=function(t,n){for(var a=e("<select>",{class:"field form-control"}),l=0;l<t.length;l++){var o=t[l],r=e("<option>",{text:o.label,value:o.name,selected:n.name==o.name});r.data("options",o.options),a.append(r)}return a}(this.fields,t),i=((l=e("<select>",{class:"operator form-control"})).change(a),l);return r.change(function(t,n){var a=this;return function(l){var o=a.operatorsFor(e(l.target).val());t.empty();for(var r=0;r<o.length;r++){var i=o[r],s=e("<option>",{text:i.label||i.name,value:i.name,selected:n.operator==i.name});s.data("fieldType",i.fieldType),t.append(s)}t.change()}}.call(this,i,t)),o.append(r),o.append(i),o.append(function(){var t=e("<span>",{class:"glyphicon glyphicon-remove",text:" "}),a=e("<a>",{class:"remove btn btn-danger btn-xs",href:"#",text:options.i18n.deleteText});return a.prepend(t),a.click(n),a}()),r.change(),o.find("> .value").val(t.value),o},operatorsFor:function(e){for(var t=0;t<this.fields.length;t++){var n=this.fields[t];if(n.name==e)return n.operators}}}}(jQuery);