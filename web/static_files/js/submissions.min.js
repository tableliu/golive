_.each(["Model","Collection"],function(e){var t=Backbone[e],i=t.prototype.fetch;t.prototype.fetch=function(){return this.trigger("fetch",this),i.apply(this,arguments)}}),Backbone.View.prototype.close=function(){this.remove(),this.unbind(),this.onClose&&this.onClose()},_.templateSettings={evaluate:/\{\{(.+?)\}\}/g,interpolate:/\{\{=(.+?)\}\}/g,escape:/\{\{-(.+?)\}\}/g};var App=App||{};App.Options={sort_attribute:"-created_at",resizeColumns:!1,showColumns:!0,minimumCountColumns:2,columns:{}},App.set=function(e,t){"undefined"!=typeof Storage?localStorage.setItem(e,JSON.stringify(t)):$.cookie(e,JSON.stringify(t),{expires:365})},App.get=function(e){return _.isNull(localStorage.getItem(e))?_.isUndefined($.cookie(e))?{}:JSON.parse($.cookie(e)):JSON.parse(localStorage.getItem(e))},App.remove=function(e){localStorage.removeItem(e),$.cookie(e,null)},App.SubmissionsView=Backbone.View.extend({className:"submissions",subViews:{},template:_.template($("#submissionsTemplate").html()),initialize:function(){this.listenTo(this.collection,"fetch",this.showProgress),this.listenTo(this.collection,"sync",this.onSync)},events:{"keyup input.searchTxt":function(e){return e.preventDefault(),13==e.keyCode&&this.collection.searchPage(e.currentTarget.value),!1},"click button#refreshBtn":function(e){e.preventDefault(),$.post(options.settingsEndPoint,{form_id:options.formID,settings:""}),location.reload()},"click button.searchBtn":function(e){return e.preventDefault(),this.collection.searchPage($("input.searchTxt").val()),!1},"click a#filter-link":function(e){return e.preventDefault(),this.collection.filterPage($(e.currentTarget).attr("data-start"),$(e.currentTarget).attr("data-end")),!1},"click input.column":function(e){e.stopImmediatePropagation();var t=this.$(e.currentTarget),i=t.val();this.$("tr.submission div:nth-child("+i+"),th:nth-child("+i+")").toggle();var n=t.data("key");App.Options.columns[n]=t.is(":checked"),$.post(options.settingsEndPoint,{form_id:options.formID,settings:JSON.stringify(App.Options)}),this.checkMinimumCountColumns()},"click button.resizeColumns":function(e){return e.preventDefault(),this.$("button.resizeColumns").toggle(),this.$("table.table").toggleClass("table-fullsize"),App.Options.resizeColumns=!App.Options.resizeColumns,App.set("form_"+options.formID+"_options",App.Options),!1},"click input#allRows":function(e){e.stopImmediatePropagation();var t=!this.$("input.row").prop("checked");this.$("input.row").prop("checked",t)},"click a#markAsRead":function(e){e.preventDefault();var t=[],i=this.$("input.row:checked");_.map(i,function(e){t.push($(e).data("id"))}),t.length>0&&this.collection.updateModelsByIds(t,{new:0})},"click a#markAsUnread":function(e){e.preventDefault();var t=[],i=this.$("input.row:checked");_.map(i,function(e){t.push($(e).data("id"))}),t.length>0&&this.collection.updateModelsByIds(t,{new:1})},"click a#deleteSelectedRows":function(e){e.preventDefault();var t=[],i=this.$("input.row:checked");_.map(i,function(e){t.push($(e).data("id"))}),t.length>0&&confirm(options.i18n.areYouSureDeleteItems)&&this.collection.destroyModelsByIds(t)},"click a#submitted_at":function(e){e.preventDefault();var t="-created_at"==this.collection.sort_attribute?"created_at":"-created_at";return this.collection.sortPage(t),!1}},onSync:function(e,t,i){_.isObject(e.models)&&this.render()},addSubview:function(e,t,i){e.get("data")?(this.subViews[e.cid]=new App.SubmissionView({model:e}),this.$("tbody").append(this.subViews[e.cid].render().el)):this.collection.destroyModelsByIds([e.get("id")])},showProgress:function(){this.$("#loading").show()},hideProgress:function(){this.$("#loading").hide()},closeSubviews:function(){_.invoke(this.subViews,"close")},onClose:function(){this.closeSubviews(),this.undelegateEvents(),this.$el.removeData().unbind(),this.remove(),Backbone.View.prototype.remove.call(this)},checkMinimumCountColumns:function(){this.$("input.column:checked").length<=App.Options.minimumCountColumns?this.$("input.column:checked").prop("disabled",!0):this.$("input.column:checked").prop("disabled",!1)},toggleColumns:function(){if(App.Options.showColumns){var e=this,t=_.map(options.fields,function(e){return e.name}),i=App.Options.columns;_.isEmpty(i)||_.keys(i).length<t.length?_.each(t,function(e){i[e]=!0}):(_.each(t,function(t){var n=e.$('input[data-key="'+t+'"]'),s=n.val(),o=i[t];o?n.prop("checked",o):(e.$("tr.submission div:nth-child("+s+"),th:nth-child("+s+")").hide(),n.prop("checked",o))}),this.checkMinimumCountColumns())}else this.$("input.column:checked").prop("disabled",!0)},resizeColumns:function(){App.Options.resizeColumns&&(this.$("button.resizeColumns").eq(0).hide(),this.$("button.resizeColumns").eq(1).show(),this.$("table.table").toggleClass("table-fullsize"))},initDatePicker:function(){var e=this,t=options.dateFormat,i=this.collection.startDate,n=this.collection.endDate;function s(i,n){e.$("#date-range").text(i.format(t)+" - "+n.format(t)),e.$("#filter-link").attr("data-start",i.format(t)),e.$("#filter-link").attr("data-end",n.format(t));var s=$.param({start:i.format(t),end:n.format(t)});e.$("#csv-link").attr("href",options.csvEndPoint+"&"+s),e.$("#xlsx-link").attr("href",options.xlsxEndPoint+"&"+s)}_.isEmpty(i)||_.isEmpty(n)?(i=moment().subtract(29,"days"),n=moment()):(i=moment(i,t),n=moment(n,t));var o=[];o[options.i18n.today]=[moment(),moment()],o[options.i18n.yesterday]=[moment().subtract(1,"days"),moment().subtract(1,"days")],o[options.i18n.last7Days]=[moment().subtract(6,"days"),moment()],o[options.i18n.last30Days]=[moment().subtract(29,"days"),moment()],o[options.i18n.thisMonth]=[moment().startOf("month"),moment().endOf("month")],o[options.i18n.lastMonth]=[moment().subtract(1,"month").startOf("month"),moment().subtract(1,"month").endOf("month")],this.$("#range").daterangepicker({startDate:i,endDate:n,locale:{customRangeLabel:options.i18n.customRange,applyLabel:options.i18n.apply,cancelLabel:options.i18n.clear},language:options.language,ranges:o},s),this.$("#range").on("cancel.daterangepicker",function(t,i){e.$("#date-range").text(""),e.$("#csv-link").attr("href",options.csvEndPoint),e.$("#xlsx-link").attr("href",options.xlsxEndPoint)}),s(i,n)},render:function(){return this.closeSubviews(),this.hideProgress(),this.el.innerHTML=this.template(this.collection.getPage()),this.$("input.searchTxt").val(this.collection.keywords),this.collection.each(this.addSubview.bind(this)),this.subViews.paginationView=new App.PaginationView({collection:this.collection}),this.$("#pagination").append(this.subViews.paginationView.render().el),this.toggleColumns(),this.resizeColumns(),this.initDatePicker(),this}}),App.SubmissionView=Backbone.View.extend({template:_.template($("#submissionTemplate").html()),tagName:"tr",className:"submission",events:{"click .view":"viewModel","click .edit":"editModel","click .remove":"removeModel"},viewModel:function(e){e.preventDefault(),App.Router.navigate("view/"+this.model.id,{trigger:!0})},editModel:function(e){e.preventDefault(),App.Router.navigate("edit/"+this.model.id,{trigger:!0})},removeModel:function(e){return e.preventDefault(),confirm(options.i18n.areYouSureDeleteItem)&&this.model.destroy({wait:!0}),!1},onClose:function(){this.undelegateEvents(),this.$el.removeData().unbind(),this.remove(),Backbone.View.prototype.remove.call(this)},render:function(){var e=this.model.get("id"),t=this.model.get("new"),i=this.model.get("submitted"),n=this.model.get("data");_.isObject(n)||(n=JSON.parse(n)),this.el.innerHTML=this.template({id:e,isNew:t,data:n,created_at:i});var s=this;return s.$('td[data-key*="selectlist"], td[data-key*="checkbox"]').each(function(e,t){s.$(t).text(function(e,t){return t.replace(/,/g,", ")})}),this}}),App.DetailView=Backbone.View.extend({tagName:"div",className:"detailView",template:_.template($("#detailTemplate").html()),initialize:function(e){if(_.isObject(this.model))this.modelExists=!0;else{var t=this;this.model=new Submission,this.model.id=e.id,this.model.url=function(){return options.hasPrettyUrls?options.endPoint+"/"+e.id:options.deleteEndPoint+"&id="+e.id},this.model.fetch({success:function(e,i){t.modelExists=!0,t.render()}})}},events:{"click .edit":"editModel","click .remove":"removeModel","click .removeFile":"removeFileModel","click #addComment":"addCommentModel","click .deleteComment":"deleteCommentModel","click #showEmptyFields":"showEmptyFields"},editModel:function(e){e.preventDefault(),App.Router.navigate("edit/"+this.model.id,{trigger:!0})},removeModel:function(e){return e.preventDefault(),confirm(options.i18n.areYouSureDeleteItem)&&this.model.destroy({wait:!0,success:function(){App.Router.navigate("",{trigger:!0})}}),!1},removeFileModel:function(e){if(e.preventDefault(),confirm(options.i18n.areYouSureDeleteFileItem)){var t=$(e.currentTarget).data("id"),i=this;$.ajax({url:options.deleteFileEndPoint,type:"POST",data:{submission_id:this.model.get("id"),file_id:t}}).done(function(e){e.success?($("tr[data-file='"+e.fileID+"']").remove(),i.model.fetch()):alert(options.i18n.errorOnDelete)}).fail(function(e,t){alert(options.i18n.errorOnDelete)})}return!1},addCommentModel:function(e){e.preventDefault();var t=this;$.ajax({url:options.addCommentEndPoint,type:"POST",data:{submission_id:this.model.get("id"),comment:$("#commentContent").val()}}).done(function(e){if(e.id){var i=t.model.get("comments");i.push(e);var n=_.uniq(i,function(e){return e.id});t.model.set("comments",n),t.render()}else alert(options.i18n.errorOnUpdate)}).fail(function(e,t){alert(options.i18n.errorOnUpdate)})},deleteCommentModel:function(e){e.preventDefault();var t=this;if(confirm(options.i18n.areYouSureDeleteCommentItem)){var i=$(e.currentTarget).data("id");$.ajax({url:options.deleteCommentEndPoint,type:"POST",data:{submission_id:t.model.get("id"),comment_id:i}}).done(function(e){if(e.success){$("li[data-comment-id='"+e.commentID+"']").remove();var i=t.model.get("comments"),n=_.reject(i,function(t){return t.id==e.commentID});t.model.set("comments",n),t.render()}else alert(options.i18n.errorOnDelete)}).fail(function(e,t){alert(options.i18n.errorOnDelete)})}return!1},showEmptyFields:function(){this.render()},onClose:function(){this.undelegateEvents(),this.$el.removeData().unbind(),this.remove(),Backbone.View.prototype.remove.call(this)},afterAppend:function(){if(_.isObject(this.map)&&"undefined"!=typeof google){var e=this.map.getCenter();google.maps.event.trigger(this.map,"resize"),this.map.setCenter(e),this.map.setZoom(12)}else _.isObject(this.map)&&this.map.invalidateSize();var t=this.$(".commentList");this.$(t).scrollTop(t[0].scrollHeight)},onRender:function(){this.model.get("new")&&this.model.save({new:0},{silent:!0});var e=this.$(".commentList");this.$(e).scrollTop(e[0].scrollHeight)},render:function(){if(this.modelExists){var e=this.model.get("id"),t=this.model.get("number"),i=this.model.get("authorName"),n=this.model.get("lastEditorName"),s=this.model.get("submitted"),o=this.model.get("updated"),a=this.model.get("ip"),r=this.model.get("sender"),l=this.model.get("data"),c=this.$("#showEmptyFields").is(":checked")?"checked":"",u=this.model.get("files"),d=this.model.get("comments");if(!_.isEmpty(u)){var p=_.keys(options.fileFields),h=[];p.forEach(function(e){var t=!1;u=u.filter(function(i){return!(!t&&i.field==e)||(h.push(i),t=!0,!1)})}),u=h.concat(u)}_.isObject(r)||(r=JSON.parse(r)),_.isObject(l)||(l=JSON.parse(l)),this.el.innerHTML=this.template({id:e,number:t,form_name:options.formName,data:l,files:u,comments:d,author:i,lastEditor:n,created_at:s,updated_at:o,sender:r,ip:a,showEmptyFields:c});var m=this;if(m.$(".table-detail").find('td[data-key*="selectlist"], td[data-key*="checkbox"]').each(function(e,t){m.$(t).text(function(e,t){return t.replace(/,/g,", ")})}),_.isNumber(r.latitude)&&_.isNumber(r.longitude)&&"undefined"!=typeof google){var f=new google.maps.LatLng(r.latitude,r.longitude),g={center:f,zoom:12,mapTypeId:google.maps.MapTypeId.ROADMAP};this.map=new google.maps.Map(this.$el.find("#map")[0],g),this.marker=new google.maps.Marker({position:f,map:this.map,title:"Sender Location"})}else _.isNumber(r.latitude)&&_.isNumber(r.longitude)&&"undefined"!=typeof L&&(this.map=L.map(this.$("#map")[0]).setView([r.latitude,r.longitude],13),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}).addTo(this.map),L.marker([r.latitude,r.longitude]).addTo(this.map));this.onRender()}return this}}),App.BulkView=Backbone.View.extend({tagName:"div",template:_.template($("#bulkTemplate").html()),onClose:function(){this.undelegateEvents(),this.$el.removeData().unbind(),this.remove(),Backbone.View.prototype.remove.call(this)},render:function(){return this.el.innerHTML=this.template(),this}}),App.FormView=Backbone.View.extend({modelExists:!1,tagName:"div",template:_.template($("#formTemplate").html()),events:{"submit #form-app":"saveModel"},initialize:function(e){if(this.subtitle=e.subtitle,_.isObject(this.model))this.modelExists=!0;else if(!_.isUndefined(e.id)){var t=this;this.model=new Submission,this.model.id=e.id,this.model.url=function(){return options.hasPrettyUrls?options.endPoint+"/"+e.id:options.deleteEndPoint+"&id="+e.id},this.model.fetch({success:function(e,i){t.modelExists=!0,t.render()}})}},saveModel:function(e){e.preventDefault();var t=$('[type="file"]'),i={},n=_.map(options.fields,function(e){return e.name});if(_.each(n,function(e){var t=_.first(e.split("_",1)),n=[];"selectlist"===t?($('select[name="'+e+'[]"] option:selected').each(function(){n.push(this.value)}),i[e]=n):"checkbox"===t?($('input[name="'+e+'[]"]:checked').each(function(){n.push(this.value)}),i[e]=n):"radio"===t?$('input[name="'+e+'"]:checked').each(function(){i[e]=this.value}):i[e]="signature"===t?$('input[name="'+e+'"]').val():$("#"+e).val()}),!_.isEmpty(i)||t.size()>0){var s=this;this.modelExists?(t.each(function(){var e=$(this).attr("name"),t=new(Backbone.Model.extend({url:options.uploadEndPoint+"&s_id="+s.model.get("id"),fileAttribute:e})),i=$(this)[0].files[0];_.isUndefined(i)||($(window).off("beforeunload").on("beforeunload",function(){return options.i18n.uploadingFile}),t.set(e,i),t.save({},{success:function(e,t){var i=s.model.get("files");i.unshift(t);var n=_.uniq(i,function(e){return e.id});s.model.set("files",n)}}),t.on("progress",function(e){1==e&&$(window).off("beforeunload")}))}),this.model.save({data:i},{success:function(){App.Router.navigate("",{trigger:!0})},error:function(e,t){alert(t.statusText)}})):this.collection.create({form_id:options.formID,data:i},{wait:!0,error:function(e,t){alert(t.statusText)},success:function(e){t.each(function(){var t=$(this).attr("name"),i=new(Backbone.Model.extend({url:options.uploadEndPoint+"&s_id="+e.get("id"),fileAttribute:t})),n=$(this)[0].files[0];void 0!==n&&($(window).off("beforeunload").on("beforeunload",function(){return options.i18n.uploadingFile}),i.set(t,n),i.save({},{success:function(e,t){s.collection.firstPage()}}),i.on("progress",function(e){1==e&&$(window).off("beforeunload")}))})}})}},onClose:function(){this.undelegateEvents(),this.$el.removeData().unbind(),this.remove(),Backbone.View.prototype.remove.call(this)},render:function(){this.el.innerHTML=this.template({form_name:options.formName,subtitle:this.subtitle}),this.modelExists&&this.populateDataInForm();var e=this.$('[type="file"]');return e.removeAttr("required"),e.parents(".form-group").removeClass("required-control"),this},populateDataInForm:function(){var e=this,t=e.model.get("data");_.isObject(t)||(t=JSON.parse(t));var i=_.map(options.fields,function(e){return e.name});return _.each(i,function(i){var n=_.first(i.split("_",1));if("selectlist"===n){var s=t[i];e.$('select[name="'+i+'[]"]').each(function(){$(this);_.isString(s)?e.$('select[name="'+i+'[]"] option[value="'+s+'"]').prop("selected",!0):_.isArray(s)&&_.each(s,function(t,n,s){console.log('select[name="'+i+'[]"] option[value="'+t+'"]'),e.$('select[name="'+i+'[]"] option[value="'+t+'"]').prop("selected",!0)})})}else if("checkbox"===n){var o=t[i];e.$('input[name="'+i+'[]"]').each(function(){var e=$(this);_.each(o,function(t,i,n){e.val()===t&&e.prop("checked",!0)})})}else if("radio"===n)e.$('input[name="'+i+'"]').each(function(e,n){var s=$(n);s.val()===t[i]&&s.prop("checked",!0)});else if("hidden_signature"===i.substring(0,16)){var a=e.$("canvas");if(a.length>0)for(var r=0;r<a.length;r++)!function(n){var s=new SignaturePad(n);if(t[i].length){var o=JSON.parse(t[i]);s.fromData(o.data)}var a=s.canvas.id,r="#hidden_"+a,l="#clear_"+a,c="#undo_"+a,u=function(){var t={data:s.toData(),dataURL:s.toDataURL()};e.$(r).val(JSON.stringify(t))};e.$(r).val(t[i]),s.onEnd=function(){u()};var d=e.$("#"+a).data("color");d&&d.length>0&&"black"!==d&&(s.penColor=d),e.$(l).on("click",function(){s.clear(),e.$(r).val("")}),e.$(c).on("click",function(){var e=s.toData();Array.isArray(e)&&e.length&&(e.pop(),s.fromData(e),u())})}(a[r])}else e.$("#"+i).val(t[i])}),this}}),App.NavView=Backbone.View.extend({template:_.template($("#navTemplate").html()),page:"Submissions",initialize:function(e){this.page=e.page},onClose:function(){this.undelegateEvents(),this.$el.removeData().unbind(),this.remove(),Backbone.View.prototype.remove.call(this)},render:function(){return this.el.innerHTML=this.template({page:this.page}),this}}),App.PaginationView=Backbone.View.extend({template:_.template($("#paginationTemplate").html()),tagName:"div",className:"kv-panel-pager",initialize:function(){_.bindAll(this,"previous","next"),this.listenTo(this.collection,"sync:page",this.render)},events:{"click a.first":"first","click a.prev":"previous","click a.next":"next","click a.last":"last"},onClose:function(){this.undelegateEvents(),this.$el.removeData().unbind(),this.remove(),Backbone.View.prototype.remove.call(this)},render:function(){return this.el.innerHTML=this.template(this.collection.getPage()),this},isDisabled:function(e){return this.$(e.currentTarget).parent().hasClass("disabled")},first:function(e){return e.preventDefault(),this.isDisabled(e)||this.collection.firstPage(),!1},previous:function(e){return e.preventDefault(),this.isDisabled(e)||this.collection.previousPage(),!1},next:function(e){return e.preventDefault(),this.isDisabled(e)||this.collection.nextPage(),!1},last:function(e){return e.preventDefault(),this.isDisabled(e)||this.collection.lastPage(),!1}});var Submission=Backbone.Model.extend({url:function(){var e=_.result(this,"urlRoot")||_.result(this.collection,"url")||urlError();return this.isNew()?e:e+("/"===e.charAt(e.length-1)?"":"&id=")+encodeURIComponent(this.id)},methodUrl:function(e){return"delete"==e?options.hasPrettyUrls?options.endPoint+"/"+this.attributes.id:options.deleteEndPoint+"&id="+this.attributes.id:"update"==e?options.hasPrettyUrls?options.endPoint+"/"+this.attributes.id:options.updateEndPoint+"&id="+this.attributes.id:"create"==e&&(options.hasPrettyUrls?options.endPoint+"/"+this.attributes.id:options.createEndPoint+"&id="+this.attributes.id)},sync:function(e,t,i){t.methodUrl&&t.methodUrl(e.toLowerCase())&&((i=i||{}).url=t.methodUrl(e.toLowerCase())),Backbone.sync(e,t,i)},initialize:function(){}}),Submissions=Backbone.Collection.extend({url:options.endPoint,model:Submission,pager:{},sort_attribute:App.Options.sort_attribute,initialize:function(){_.bindAll(this,"parse","destroyModelsByIds","loadPager","getPage","reloadPage","showPage","firstPage","lastPage","nextPage","previousPage","searchPage"),options.hasPrettyUrls&&(this.model=Backbone.Model),this.pager.currentPage=1,this.keywords="",this.startDate="",this.endDate="",this.sort_attribute=App.Options.sort_attribute,this.listenTo(this,"destroy",this.onDestroy),this.listenTo(this,"sync",this.onSync)},onSync:function(e,t,i){if(!_.isObject(e.models))return t.updated_at>t.created_at||!_.isNull(t.new)&&!t.new||this.firstPage().then(function(){App.Router.navigate("",{trigger:!0})}),!1},onDestroy:function(e){this.fetchPage()},parse:function(e){return this.pager=e._meta,e.items},updateModelsByIds:function(e,t){var i=this;$.ajax({url:options.updateAllEndPoint,type:"POST",data:{id:options.formID,ids:e,attributes:t}}).done(function(e){e.success&&e.itemsUpdated>0?i.reloadPage():alert(options.i18n.errorOnUpdate)}).fail(function(e,t){alert(options.i18n.errorOnUpdate)})},destroyModelsByIds:function(e){var t=this;$.ajax({url:options.deleteAllEndPoint,type:"POST",data:{id:options.formID,ids:e}}).done(function(e){e.success&&e.itemsDeleted>0?t.pager.currentPage==t.pager.pageCount?t.previousPage():t.reloadPage():alert(options.i18n.errorOnDelete)}).fail(function(e,t){alert(options.i18n.errorOnDelete)})},loadPager:function(){return this.pager.pageCount=Math.ceil(this.pager.totalCount/this.pager.perPage),this.pager.prev=!1,this.pager.next=!1,this.pager.range={min:this.pager.totalCount?(this.pager.currentPage-1)*this.pager.perPage+1:this.pager.totalCount,max:Math.min(this.pager.totalCount,this.pager.currentPage*this.pager.perPage)},this.pager.currentPage>1&&(this.pager.prev=this.pager.currentPage-1),this.pager.currentPage<this.pager.pageCount&&(this.pager.next=this.pager.currentPage+1),this},getPage:function(){return this.loadPager(),this.pager},reloadPage:function(){return this.fetchPage()},showPage:function(e){return this.pager.currentPage=e,this.fetchPage()},nextPage:function(){return++this.pager.currentPage,this.fetchPage()},previousPage:function(){return--this.pager.currentPage,this.fetchPage()},firstPage:function(){return this.pager.currentPage=1,this.fetchPage()},lastPage:function(){return this.pager.currentPage=this.pager.pageCount,this.fetchPage()},searchPage:function(e){return this.keywords=e,this.pager.currentPage=1,this.fetchPage()},filterPage:function(e,t){return this.startDate=e,this.endDate=t,this.pager.currentPage=1,this.fetchPage()},sortPage:function(e){return this.sort_attribute=e,App.Options.sort_attribute=e,App.set("form_"+options.formID+"_options",App.Options),this.pager.currentPage=1,this.fetchPage()},fetchPage:function(){var e=this;return this.fetch({data:$.param({id:options.formID,q:this.keywords,sort:this.sort_attribute,page:this.pager.currentPage,start:this.startDate,end:this.endDate}),reset:!0,success:function(){e.trigger("sync:page")}})}}),Router=Backbone.Router.extend({views:{},initialize:function(e){this.main=e.main,this.submissions=e.submissions,this.routesHit=0,Backbone.history.on("route",function(){this.routesHit++},this)},routes:{"":"index",back:"back",add:"add","edit/:id":"edit","view/:id":"view"},closeViews:function(){_.invoke(this.views,"close")},index:function(){this.closeViews(),this.views.navView=new App.NavView({page:options.i18n.index,collection:this.submissions}),this.main.html(this.views.navView.render().el),this.views.submissionsView=new App.SubmissionsView({collection:this.submissions}),this.main.append(this.views.submissionsView.render().el)},back:function(){this.routesHit>1?(this.routesHit=this.routesHit-2,window.history.back()):("/"!=Backbone.history.getFragment()&&(this.routesHit=0),this.navigate("",{trigger:!0,replace:!0}))},bulk:function(){this.closeViews(),this.views.navView=new App.NavView({page:options.i18n.bulkActions}),this.main.html(this.views.navView.render().el),this.views.bulkView=new App.BulkView,this.main.append(this.views.bulkView.render().el)},add:function(){this.closeViews(),this.views.navView=new App.NavView({page:options.i18n.addSubmission,collection:this.submissions}),this.main.html(this.views.navView.render().el),this.views.formView=new App.FormView({subtitle:options.i18n.addSubmission,collection:this.submissions}),this.main.append(this.views.formView.render().el)},edit:function(e){this.closeViews(),this.views.navView=new App.NavView({page:options.i18n.editSubmission,collection:this.submissions}),this.main.html(this.views.navView.render().el),this.views.formView=new App.FormView({id:e,subtitle:options.i18n.editSubmission,model:this.submissions.get(e)}),this.main.append(this.views.formView.render().el)},view:function(e){this.closeViews(),this.views.navView=new App.NavView({page:options.i18n.submissionDetails,collection:this.submissions}),this.main.html(this.views.navView.render().el),this.views.detailView=new App.DetailView({id:e,model:this.submissions.get(e)}),this.main.append(this.views.detailView.render().el),this.views.detailView.afterAppend()}});App.init=function(){var e=JSON.parse(options.settings);return _.isEmpty(e)||(App.Options=e),App.Submissions=new Submissions,App.Submissions.fetchPage().then(function(){App.Router=new Router({main:$("#main"),submissions:App.Submissions}),Backbone.history.start()})},$(function(){App.init()});