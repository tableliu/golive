$(document).ready(function(){window.formEl=$(options.name);var e,t,o,r,s=$("#progress"),n=$("#bar"),a=$("#percent"),l=$("fieldset");formEl.attr("role","form"),$("<input>").attr({type:"hidden",id:"_csrf",name:"_csrf",value:options._csrf}).appendTo(formEl),options.autocomplete?formEl.attr("autocomplete","on"):formEl.attr("autocomplete","off"),options.novalidate?formEl.attr("novalidate","novalidate"):"novalidate"!==formEl.attr("novalidate")&&formEl.removeAttr("novalidate"),options.resume&&formEl.resume({key:"form_app_"+options.id}),setInterval(function(){var e=Math.max(window.document.body.scrollHeight,window.document.body.offsetHeight,window.document.documentElement.offsetHeight);r!==e&&(Utils.postMessage({height:e}),r=e)},100),$(window).load(function(){if("preview"===options.mode)return!1;var e=Utils.getUrlVars().parentUrl;(e=e&&e.length>0?decodeURIComponent(e):window.location.href)&&e.length>0&&formEl.find(":input").each(function(){var t=$(this),o=Utils.getUrlVars(e)[t.attr("id")];!o&&t.data("alias")&&t.data("alias").length>0&&(o=Utils.getUrlVars(e)[t.data("alias")]),"checkbox"===t.attr("type")||"radio"===t.attr("type")?"true"!==o&&"false"!==o||t.prop("checked","true"===o):o&&t.val(o),t.trigger("change")}),options.defaultValues&&(options.defaultValues=JSON.parse(options.defaultValues),$.each(options.defaultValues,function(e,t){var o=e.split("_",1),r=$("#"+e);"checkbox"===o||"radio"===o?r.prop("checked",t):r.val(t),r.trigger("change")}));var t=$("canvas");if(t.length>0)for(var o=0;o<t.length;o++)!function(e){var t=new SignaturePad(e),o=t.canvas.id,r="#hidden_"+o,i="#clear_"+o,s="#undo_"+o,n=function(){if(t.toData().length>0){var e={data:t.toData(),dataURL:t.toDataURL()};$(r).val(JSON.stringify(e))}else $(r).val("");$(r).trigger("change")};t.onEnd=function(){n()};var a=$("#"+o).data("color");a&&a.length>0&&"black"!==a&&(t.penColor=a),$(i).on("click",function(){t.clear(),n()}),$(s).on("click",function(){var e=t.toData();e&&(e.pop(),t.fromData(e),n())}),formEl.on("success",function(){t.clear(),n()})}(t[o]);formEl.trigger("view")});var d=!1,c=0;function f(){$(".error-block").remove(),$(".form-group").removeClass("has-error")}formEl.find(":input").each(function(){$(this).one("change",function(){if(!1===d){if("preview"===options.mode)return!1;c=(new Date).getTime(),formEl.trigger("fill")}d=!0})}),window.nextStep=function(r){r.preventDefault();var i=!1;if(t=$(r.currentTarget).parents("fieldset").next(),e=$(this).parents("fieldset"),options.skips.length>0)for(var s=0;s<options.skips.length;s++)if(l.index(e)<options.skips[s].to){var n=l.eq(options.skips[s].to);if(l.index(e)<l.index(n)){null!=options.skips[s].from&&options.skips[s].from!=l.index(e)||(options.skips[s].from=l.index(e),t=n);break}}t.is("fieldset")&&$.ajax({url:options.validationUrl,type:"post",data:formEl.serialize(),headers:{"X-Requested-With":"XMLHttpRequest",Accept:"application/json"},complete:function(e,t){},beforeSend:function(t,o){var r=e.find("input:file[required]");r.size()>0&&$.each(r,function(){$(this).val()&&(o.data=o.data+"&"+$(this).attr("name")+"=1")}),o.data=o.data+"&current_page="+l.index(e)},success:function(r){if(null!==r&&"object"==typeof r&&(e.find(".error-block").remove(),e.find(".form-group").removeClass("has-error"),$.each(r,function(t,o){var r=e.find("#"+t).parent(".form-group");if(r.size()>0){i=!0,r.addClass("has-error");var s=$("<div>",{class:"help-block error-block",html:o});r.append(s)}})),!i){e.hide();var s=$(".steps");if(s.size()>0)s.find(".step").eq(l.index(e)).removeClass("current"),s.find(".step").eq(l.index(t)).prevAll().addClass("success"),s.find(".step").eq(l.index(t)).addClass("current");else{var n=$(".progress").first().find(".progress-bar"),a=n.find(".percent"),d=n.find(".title"),c=n.data("titles");if(void 0!==c){var f=(c=c.split(","))[l.index(t)];d.html(f)}var p=Math.round(100/l.size()*l.index(t))+"%";a.text(p),n.width(p)}t.show(),o=e}formEl.trigger("nextStep"),Utils.postMessage({scrollToTop:"container"})},error:function(){Utils.showMessage("#messages",options.i18n.unexpectedError,"danger"),formEl.hide(),Utils.postMessage({scrollToTop:"container"})}})},window.previousStep=function(t){if(t.preventDefault(),o.is("fieldset")){e=$(this).parents("fieldset");for(var r=0;r<options.skips.length;r++)if(l.index(e)==options.skips[r].to){o=l.eq(options.skips[r].from);break}var i=$(".steps");if(i.size()>0)i.find(".step").removeClass("success"),i.find(".step").eq(l.index(e)).removeClass("current"),i.find(".step").eq(l.index(o)).prevAll().addClass("success"),i.find(".step").eq(l.index(o)).addClass("current");else{var s=$(".progress").first().find(".progress-bar"),n=s.find(".percent"),a=s.find(".title"),d=s.data("titles");if(void 0!==d){var c=(d=d.split(","))[l.index(o)];a.html(c)}var f=Math.round(100/l.size()*l.index(o))+"%";n.text(f),s.width(f)}e.hide(),o.show(),o=o.prev(),formEl.trigger("previousStep"),Utils.postMessage({scrollToTop:"container"})}},$("input").on("keypress",function(e){if(13==e.keyCode){var t=$(e.currentTarget).parents("fieldset").find(".next");if(t.size()>0)return e.preventDefault(),t.click(),!1}}),$(".next").click(nextStep),$(".previous").click(previousStep),formEl.ajaxForm({url:options.actionUrl,type:"post",dataType:"json",beforeSubmit:function(e,t,o){if("preview"===options.mode)return!1;var r=!1;if($.each(t.find('input[type="file"]'),function(e,t){$(t).val()&&(r=!0)}),r){s.show();n.css("width","0%"),a.html("0% "+options.i18n.complete)}formEl.find(":submit").attr("disabled",!0)},uploadProgress:function(e,t,o,r){var i=r+"%";n.css("width",i),a.html(i+" "+options.i18n.complete)},success:function(e){e.success?(f(),formEl.find(":submit").attr("disabled",!1),formEl.resetForm(),s.hide(),function(e){options.submitted=!0;var t=(new Date).getTime()-c;if(formEl.trigger("success",[e,t]),l.size()>1){var o=$(".steps");if(o.size()>0)o.find(".step").addClass("success");else{var r=$(".progress").first(),i=r.find(".progress-bar"),s=i.find(".percent"),n=i.find(".title");n.html("Complete"),s.text("100%"),i.width("100%")}}if(void 0!==e.addon&&void 0!==e.addon.redirectTo){var a=e.addon.redirectTo;window.location!==window.parent.location?Utils.postMessage({url:a}):window.location.href=a||"/"}if(options.confirmationType===options.redirectToUrl){var a=void 0===e.confirmationUrl?options.confirmationUrl:e.confirmationUrl;window.location!==window.parent.location?Utils.postMessage({url:a}):window.location.href=a||"/"}else{var d=options.confirmationMessage?options.confirmationMessage:e.message;Utils.hideMessage("#messages"),Utils.showMessage("#messages",d,"success"),options.confirmationType===options.showOnlyMessage&&formEl.hide(),Utils.postMessage({scrollToTop:"container"})}}(e)):function(e){Utils.hideMessage("#messages"),void 0!==e.message&&Utils.showMessage("#messages",e.message,"danger");if(Utils.postMessage({scrollToTop:"container"}),f(),void 0!==e.errors&&e.errors.length>0){var t=e.errors;for(k=0;k<t.length;k++){var o=$("#"+t[k].field).closest(".form-group");for(o.addClass("has-error"),i=0;i<t[k].messages.length;i++){var r=$("<div>",{class:"help-block error-block",html:t[k].messages[i]});o.append(r)}}}formEl.find(":submit").removeAttr("disabled"),formEl.trigger("error",e)}(e)},error:function(e,t,o){Utils.showMessage("#messages",options.i18n.unexpectedError,"danger"),formEl.hide(),Utils.postMessage({scrollToTop:"container"})}}),options.analytics&&(!function(e,t,o,r,i,s,n){e[i]||(e.FA=e.FA||[],e.FA.push(i),e[i]=function(){(e[i].q=e[i].q||[]).push(arguments)},e[i].q=e[i].q||[],s=t.createElement(o),n=t.getElementsByTagName(o)[0],s.async=1,s.src=r,n.parentNode.insertBefore(s,n))}(window,document,"script",options.tracker,"tracker"),window.tracker("newTracker","t"+options.id,options.app,{encodeBase64:!1,appId:options.id}),formEl.on("view",function(e){window.tracker("setCustomUrl",decodeURIComponent(Utils.getUrlVars().url)),window.tracker("setReferrerUrl",decodeURIComponent(Utils.getUrlVars().referrer)),window.tracker("trackPageView",decodeURIComponent(Utils.getUrlVars().title))}),formEl.on("fill",function(e){window.tracker("trackStructEvent","form","fill","start",null,null)}),formEl.on("error",function(e){window.tracker("trackStructEvent","form","error",null,null,null)}),formEl.on("success",function(e,t,o){window.tracker("trackStructEvent","form","submit",t.id,"time",o)}))});